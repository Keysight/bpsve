{
	"AWSTemplateFormatVersion": "2010-09-09",
	"Description": "BPS on AWS 1-Virtual-Blade Add-On Test CloudFormation",
	"Parameters" : {
		"UserEmailTag" : {
			"Description" : "Email address tag of user creating the stack",
			"MinLength": "14",
			"Type" : "String",
			"Default" : "test@keysight.com"
		},
		"UserLoginTag" : {
			"Description" : "Login ID tag of user creating the stack",
			"MinLength": "4",
			"Type" : "String",
			"Default" : "ixia"
		},
		"SSHKey": {
			"Description": "Name of an existing EC2 KeyPair to enable SSH access",
			"Type": "AWS::EC2::KeyPair::KeyName",
			"Default": "your-own-ssh-key"
		},	  
		"VpcId" : {
			"Description" : "Virtual Private Cloud ID",
			"Type" : "AWS::EC2::VPC::Id"
		},
		"CtrlSubnetId" : {
			"Description" : "Control Subnet ID",
			"Type" : "AWS::EC2::Subnet::Id"
		},
		"Test1SubnetId" : {
			"Description" : "Test1 Subnet ID",
			"Type" : "AWS::EC2::Subnet::Id"
		},
		"Test2SubnetId" : {	  
			"Description" : "Test2 Subnet ID",
			"Type" : "AWS::EC2::Subnet::Id"
		},
		"BPSSCInstanceType" : {
			"Description" : "Instance type of BPS-VE Virtual Controller VM",
			"Type" : "String",
			"AllowedValues": [
				"c6in.4xlarge",
				"c5n.4xlarge",
				"c5.4xlarge"
			],
			"Default" : "c5.4xlarge"
		},
		"BPSSCCtrl0PrivateIpAddress" : {
			"AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})",
			"ConstraintDescription": "must be a valid IP Address of the form x.x.x.x",
			"Description" : "Virtual Controller Management Subnet IP Address",
			"Type" : "String",
			"Default" : "10.0.1.12"
		},
		"BPSvBladeInstanceType" : {
			"Description" : "Instance type of BPS-VE Virtual Blade VM",
			"Type" : "String",
			"AllowedValues": [
				"c6in.4xlarge",
				"c5n.4xlarge",
				"c5.4xlarge"
			],
			"Default" : "c5.4xlarge"
		},
		"BPSvBlade1Eth0PrivateIpAddress" : {
			"AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})",
			"ConstraintDescription": "must be a valid IP Address of the form x.x.x.x",
			"Description" : "Virtual Blade 1 Eth0 Control Subnet IP Address",
			"Type" : "String",
			"Default" : "10.0.1.13"
		},
		"BPSvBlade1Eth1PrivateIpAddresses" : {
			"Description" : "Virtual Blade 1 Eth1 Test1 Subnet IP Address CSV list",
			"Type" : "CommaDelimitedList",
			"Default" : "10.0.2.22,10.0.2.23,10.0.2.24,10.0.2.25,10.0.2.26,10.0.2.27,10.0.2.28,10.0.2.29,10.0.2.30,10.0.2.31"
		},
		"BPSvBlade1Eth2PrivateIpAddresses" : {
			"Description" : "Virtual Blade 1 Eth2 Test2 Subnet IP Address CSV list",
			"Type" : "CommaDelimitedList",
			"Default" : "10.0.3.22,10.0.3.23,10.0.3.24,10.0.3.25,10.0.3.26,10.0.3.27,10.0.3.28,10.0.3.29,10.0.3.30,10.0.3.31"
		},
		"InboundIPv4CidrBlock" : {
			"AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
			"ConstraintDescription": "must be a valid IP CIDR range of the form x.x.x.x/x.",
			"Description" : "IP Address /32 or IP CIDR range connecting inbound to BPS-VE VMs",
			"MaxLength": "18",
			"MinLength": "9",
			"Type" : "String",
			"Default" : "213.249.122.234/32"
		}
    },
	"Mappings" : {
		"VariableMap" : {
			"local" : {
				"OPTIONSxTAG" : "MANUAL",
				"PROJECTxTAG" : "bpsve",
				"PLACEMENTxGROUPxSTRATEGY" : "cluster",
				"INTERFACExSOURCExDESTxCHECK" : true,
				"INSTANCExDISABLExAPIxTERMINATION" : false,
				"INSTANCExMONITORING" : false,
				"INSTANCExINSTANCExINITIATEDxSHUTDOWNxBEHAVIOR" : "stop",
				"INSTANCExBLOCKxDEVICExNAME" : "/dev/sda1",
				"INSTANCExEBSxDELETExONxTERMINATION" : true,
				"INSTANCExEBSxVOLUMExTYPE" : "gp2",
				"APPxTAG" : "BPS",
				"APPxVERSION" : "26.0.0",
				"SYSCTRLxIMGxSIZE" : "30",
				"VBLADExIMGxSIZE" : "10"                                                     
			}
		}
	},
	"Resources": {
		"PlacementGroup": {
			"Type" : "AWS::EC2::PlacementGroup",
			"Properties" : {
				"Strategy" : { "Fn::FindInMap" : [ "VariableMap", "local", "PLACEMENTxGROUPxSTRATEGY"] }
			}
		},
        "CtrlSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": { "Fn::Join" : [ "_", [ { "Ref" : "UserLoginTag" }, { "Fn::FindInMap" : [ "VariableMap", "local", "PROJECTxTAG"] }, "CTRL_SECURITY_GROUP", 
					{ "Fn::FindInMap" : [ "RegionMap", { "Ref" : "AWS::Region" }, "REGIONxTAG"]} ] ] },
				"VpcId": {
                    "Ref": "VpcId"
                },
				"Tags": [
					{
						"Key": "Name",
						    "Value": { "Fn::Join" : [ "_", [ { "Ref" : "UserLoginTag" }, { "Fn::FindInMap" : [ "VariableMap", "local", "PROJECTxTAG"] }, "CTRL_SECURITY_GROUP", 
							    { "Ref" : "AWS::Region" } ] ] }
					},
					{
						"Key": "Owner",
						"Value": { "Ref" : "UserEmailTag" }
					},
					{
						"Key": "Options",
						"Value": { "Fn::FindInMap" : [ "VariableMap", "local", "OPTIONSxTAG"] }
					},
					{
						"Key": "Project",
						"Value": { "Fn::FindInMap" : [ "VariableMap", "local", "PROJECTxTAG"] }
					}
				]
			}
		},
		"CtrlIngress1": {
			"Type": "AWS::EC2::SecurityGroupIngress",
			"Properties": {
				"GroupId": {
					"Ref": "CtrlSecurityGroup"
				},
				"IpProtocol": "-1",
				"SourceSecurityGroupId": {
					"Ref": "CtrlSecurityGroup"
				}
			}
		},
		"CtrlIngress2": {
			"Type": "AWS::EC2::SecurityGroupIngress",
			"Properties": {
				"GroupId": {
					"Ref": "CtrlSecurityGroup"
				},
				"IpProtocol": "tcp",
				"FromPort": 22,
				"ToPort": 22,
				"CidrIp": { "Ref" : "InboundIPv4CidrBlock" }
			}
		},
		"CtrlIngress22": {
			"Type": "AWS::EC2::SecurityGroupIngress",
			"Properties": {
				"GroupId": {
					"Ref": "CtrlSecurityGroup"
				},
				"IpProtocol": "tcp",
				"FromPort": 22,
				"ToPort": 22,
				"CidrIp": { "Ref" : "InboundIPv4CidrBlock" }
			}
		},		
		"CtrlIngress80": {
			"Type": "AWS::EC2::SecurityGroupIngress",
			"Properties": {
				"GroupId": {
					"Ref": "CtrlSecurityGroup"
				},
				"IpProtocol": "tcp",
				"FromPort": 80,
				"ToPort": 80,
				"CidrIp": { "Ref" : "InboundIPv4CidrBlock" }
			}
		},
		"CtrlIngress443": {
			"Type": "AWS::EC2::SecurityGroupIngress",
			"Properties": {
				"GroupId": {
					"Ref": "CtrlSecurityGroup"
				},
				"IpProtocol": "tcp",
				"FromPort": 443,
				"ToPort": 443,
				"CidrIp": { "Ref" : "InboundIPv4CidrBlock" }
			}
		},
		"CtrlIngress8880": {
			"Type": "AWS::EC2::SecurityGroupIngress",
			"Properties": {
				"GroupId": {
					"Ref": "CtrlSecurityGroup"
				},
				"IpProtocol": "tcp",
				"FromPort": 8880,
				"ToPort": 8880,
				"CidrIp": { "Ref" : "InboundIPv4CidrBlock" }
			}
		},
        "Test1SecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": { "Fn::Join" : [ "_", [ { "Ref" : "UserLoginTag" }, { "Fn::FindInMap" : [ "VariableMap", "local", "PROJECTxTAG"] }, "TEST1_SECURITY_GROUP", 
					{ "Fn::FindInMap" : [ "RegionMap", { "Ref" : "AWS::Region" }, "REGIONxTAG"]} ] ] },
                "VpcId": {
                    "Ref": "VpcId"
                },
				"Tags": [
					{
						"Key": "Name",
						"Value": { "Fn::Join" : [ "_", [ { "Ref" : "UserLoginTag" }, { "Fn::FindInMap" : [ "VariableMap", "local", "PROJECTxTAG"] }, "TEST1_SECURITY_GROUP", 
							{ "Ref" : "AWS::Region" } ] ] }
					},
					{
						"Key": "Owner",
						"Value": { "Ref" : "UserEmailTag" }
					},
					{
						"Key": "Options",
						"Value": { "Fn::FindInMap" : [ "VariableMap", "local", "OPTIONSxTAG"] }
					},
					{
						"Key": "Project",
						"Value": { "Fn::FindInMap" : [ "VariableMap", "local", "PROJECTxTAG"] }
					}
				]
			}
		},
		"Test1Ingress1": {
			"Type": "AWS::EC2::SecurityGroupIngress",
			"Properties": {
				"GroupId": {
					"Ref": "Test1SecurityGroup"
				},
				"IpProtocol": "-1",
				"SourceSecurityGroupId": {
					"Ref": "Test1SecurityGroup"
				}
			}
		},
		"BpsSystemControllerCtrl0": {
			"Type": "AWS::EC2::NetworkInterface",
			"Properties": {
				"Description": { "Fn::Join" : [ "_", [ { "Ref" : "UserLoginTag" }, { "Fn::FindInMap" : [ "VariableMap", "local", "PROJECTxTAG"] }, 
					{ "Fn::FindInMap" : [ "VariableMap", "local", "APPxTAG"] }, "SYSTEM_CONTROLLER", 
					{ "Fn::FindInMap" : [ "VariableMap", "local", "APPxVERSION"] }, "CTRL0", 
					{ "Fn::FindInMap" : [ "RegionMap", { "Ref" : "AWS::Region" }, "REGIONxTAG"]} ] ] },
				"SourceDestCheck": { "Fn::FindInMap" : [ "VariableMap", "local", "INTERFACExSOURCExDESTxCHECK"] },
				"SubnetId": {
					"Ref": "CtrlSubnetId"
				},
				"GroupSet": [
					{
						"Ref": "CtrlSecurityGroup"
					}
				],
				"PrivateIpAddress": { "Ref" : "BPSSCCtrl0PrivateIpAddress" },
				"Tags": [
					{
						"Key": "Name",
						"Value": { "Fn::Join" : [ "_", [ { "Ref" : "UserLoginTag" }, { "Fn::FindInMap" : [ "VariableMap", "local", "PROJECTxTAG"] }, 
							{ "Fn::FindInMap" : [ "VariableMap", "local", "APPxTAG"] }, "SYSTEM_CONTROLLER", 
							{ "Fn::FindInMap" : [ "VariableMap", "local", "APPxVERSION"] }, "CTRL0", 
							{ "Ref" : "AWS::Region" } ] ] }
					},
					{
						"Key": "Owner",
						"Value": { "Ref" : "UserEmailTag" }
					},
					{
						"Key": "Options",
						"Value": { "Fn::FindInMap" : [ "VariableMap", "local", "OPTIONSxTAG"] }
					},
					{
						"Key": "Project",
						"Value": { "Fn::FindInMap" : [ "VariableMap", "local", "PROJECTxTAG"] }
					}
				]
			}
		},
		"BpsVirtualBlade1Eth0": {
			"Type": "AWS::EC2::NetworkInterface",
			"Properties": {
				"Description": { "Fn::Join" : [ "_", [ { "Ref" : "UserLoginTag" }, { "Fn::FindInMap" : [ "VariableMap", "local", "PROJECTxTAG"] }, 
					{ "Fn::FindInMap" : [ "VariableMap", "local", "APPxTAG"] }, "VIRTUAL_BLADE1", 
					{ "Fn::FindInMap" : [ "VariableMap", "local", "APPxVERSION"] }, "ETH0", 
					{ "Fn::FindInMap" : [ "RegionMap", { "Ref" : "AWS::Region" }, "REGIONxTAG"]} ] ] },
				"SourceDestCheck": { "Fn::FindInMap" : [ "VariableMap", "local", "INTERFACExSOURCExDESTxCHECK"] },
				"SubnetId": {
					"Ref": "CtrlSubnetId"
				},
				"GroupSet": [
					{
						"Ref": "CtrlSecurityGroup"
					}
				],
				"PrivateIpAddress": { "Ref" : "BPSvBlade1Eth0PrivateIpAddress" },
				"Tags": [
					{
						"Key": "Name",
						"Value": { "Fn::Join" : [ "_", [ { "Ref" : "UserLoginTag" }, { "Fn::FindInMap" : [ "VariableMap", "local", "PROJECTxTAG"] }, 
							{ "Fn::FindInMap" : [ "VariableMap", "local", "APPxTAG"] }, "VIRTUAL_BLADE1", 
							{ "Fn::FindInMap" : [ "VariableMap", "local", "APPxVERSION"] }, "ETH0", 
							{ "Ref" : "AWS::Region" } ] ] }
					},
					{
						"Key": "Owner",
						"Value": { "Ref" : "UserEmailTag" }
					},
					{
						"Key": "Options",
						"Value": { "Fn::FindInMap" : [ "VariableMap", "local", "OPTIONSxTAG"] }
					},
					{
						"Key": "Project",
						"Value": { "Fn::FindInMap" : [ "VariableMap", "local", "PROJECTxTAG"] }
					}
				]
			}
		},
		"BpsVirtualBlade1Eth1": {
			"Type": "AWS::EC2::NetworkInterface",
			"Properties": {
				"Description": { "Fn::Join" : [ "_", [ { "Ref" : "UserLoginTag" }, { "Fn::FindInMap" : [ "VariableMap", "local", "PROJECTxTAG"] }, 
					{ "Fn::FindInMap" : [ "VariableMap", "local", "APPxTAG"] }, "VIRTUAL_BLADE1", 
					{ "Fn::FindInMap" : [ "VariableMap", "local", "APPxVERSION"] }, "ETH1", 
					{ "Fn::FindInMap" : [ "RegionMap", { "Ref" : "AWS::Region" }, "REGIONxTAG"]} ] ] },
				"SourceDestCheck": { "Fn::FindInMap" : [ "VariableMap", "local", "INTERFACExSOURCExDESTxCHECK"] },
				"SubnetId": {
					"Ref": "Test1SubnetId"
				},
				"GroupSet": [
					{
						"Ref": "Test1SecurityGroup"
					}
				],
				"PrivateIpAddress": { "Fn::Select" : [ "0", {"Ref" : "BPSvBlade1Eth1PrivateIpAddresses"} ] },
				"PrivateIpAddresses": [
					{
						"PrivateIpAddress": { "Fn::Select" : [ "1", {"Ref" : "BPSvBlade1Eth1PrivateIpAddresses"} ] },
						"Primary": false
					},
					{
						"PrivateIpAddress": { "Fn::Select" : [ "2", {"Ref" : "BPSvBlade1Eth1PrivateIpAddresses"} ] },
						"Primary": false
					},
					{
						"PrivateIpAddress": { "Fn::Select" : [ "3", {"Ref" : "BPSvBlade1Eth1PrivateIpAddresses"} ] },
						"Primary": false
					},
					{
						"PrivateIpAddress": { "Fn::Select" : [ "4", {"Ref" : "BPSvBlade1Eth1PrivateIpAddresses"} ] },
						"Primary": false
					},
					{
						"PrivateIpAddress": { "Fn::Select" : [ "5", {"Ref" : "BPSvBlade1Eth1PrivateIpAddresses"} ] },
						"Primary": false
					},
					{
						"PrivateIpAddress": { "Fn::Select" : [ "6", {"Ref" : "BPSvBlade1Eth1PrivateIpAddresses"} ] },
						"Primary": false
					},
					{
						"PrivateIpAddress": { "Fn::Select" : [ "7", {"Ref" : "BPSvBlade1Eth1PrivateIpAddresses"} ] },
						"Primary": false
					},
					{
						"PrivateIpAddress": { "Fn::Select" : [ "8", {"Ref" : "BPSvBlade1Eth1PrivateIpAddresses"} ] },
						"Primary": false
					},
					{
						"PrivateIpAddress": { "Fn::Select" : [ "9", {"Ref" : "BPSvBlade1Eth1PrivateIpAddresses"} ] },
						"Primary": false
					}
				],
				"Tags": [
					{
						"Key": "Name",
						"Value": { "Fn::Join" : [ "_", [ { "Ref" : "UserLoginTag" }, { "Fn::FindInMap" : [ "VariableMap", "local", "PROJECTxTAG"] }, 
							{ "Fn::FindInMap" : [ "VariableMap", "local", "APPxTAG"] }, "VIRTUAL_BLADE1", 
							{ "Fn::FindInMap" : [ "VariableMap", "local", "APPxVERSION"] }, "ETH1", 
							{ "Ref" : "AWS::Region" } ] ] }
					},
					{
						"Key": "Owner",
						"Value": { "Ref" : "UserEmailTag" }
					},
					{
						"Key": "Options",
						"Value": { "Fn::FindInMap" : [ "VariableMap", "local", "OPTIONSxTAG"] }
					},
					{
						"Key": "Project",
						"Value": { "Fn::FindInMap" : [ "VariableMap", "local", "PROJECTxTAG"] }
					}
				]
			}
		},
		"BpsVirtualBlade1Eth2": {
			"Type": "AWS::EC2::NetworkInterface",
			"Properties": {
				"Description": { "Fn::Join" : [ "_", [ { "Ref" : "UserLoginTag" }, { "Fn::FindInMap" : [ "VariableMap", "local", "PROJECTxTAG"] }, 
					{ "Fn::FindInMap" : [ "VariableMap", "local", "APPxTAG"] }, "VIRTUAL_BLADE1", 
					{ "Fn::FindInMap" : [ "VariableMap", "local", "APPxVERSION"] }, "ETH2", 
					{ "Fn::FindInMap" : [ "RegionMap", { "Ref" : "AWS::Region" }, "REGIONxTAG"]} ] ] },
				"SourceDestCheck": { "Fn::FindInMap" : [ "VariableMap", "local", "INTERFACExSOURCExDESTxCHECK"] },
				"SubnetId": {
					"Ref": "Test2SubnetId"
				},
				"GroupSet": [
					{
						"Ref": "Test1SecurityGroup"
					}
				],
				"PrivateIpAddress": { "Fn::Select" : [ "0", {"Ref" : "BPSvBlade1Eth2PrivateIpAddresses"} ] },
				"PrivateIpAddresses": [
					{
						"PrivateIpAddress": { "Fn::Select" : [ "1", {"Ref" : "BPSvBlade1Eth2PrivateIpAddresses"} ] },
						"Primary": false
					},
					{
						"PrivateIpAddress": { "Fn::Select" : [ "2", {"Ref" : "BPSvBlade1Eth2PrivateIpAddresses"} ] },
						"Primary": false
					},
					{
						"PrivateIpAddress": { "Fn::Select" : [ "3", {"Ref" : "BPSvBlade1Eth2PrivateIpAddresses"} ] },
						"Primary": false
					},
					{
						"PrivateIpAddress": { "Fn::Select" : [ "4", {"Ref" : "BPSvBlade1Eth2PrivateIpAddresses"} ] },
						"Primary": false
					},
					{
						"PrivateIpAddress": { "Fn::Select" : [ "5", {"Ref" : "BPSvBlade1Eth2PrivateIpAddresses"} ] },
						"Primary": false
					},
					{
						"PrivateIpAddress": { "Fn::Select" : [ "6", {"Ref" : "BPSvBlade1Eth2PrivateIpAddresses"} ] },
						"Primary": false
					},
					{
						"PrivateIpAddress": { "Fn::Select" : [ "7", {"Ref" : "BPSvBlade1Eth2PrivateIpAddresses"} ] },
						"Primary": false
					},
					{
						"PrivateIpAddress": { "Fn::Select" : [ "8", {"Ref" : "BPSvBlade1Eth2PrivateIpAddresses"} ] },
						"Primary": false
					},
					{
						"PrivateIpAddress": { "Fn::Select" : [ "9", {"Ref" : "BPSvBlade1Eth2PrivateIpAddresses"} ] },
						"Primary": false
					}
				],
				"Tags": [
					{
						"Key": "Name",
						"Value": { "Fn::Join" : [ "_", [ { "Ref" : "UserLoginTag" }, { "Fn::FindInMap" : [ "VariableMap", "local", "PROJECTxTAG"] }, 
							{ "Fn::FindInMap" : [ "VariableMap", "local", "APPxTAG"] }, "VIRTUAL_BLADE1", 
							{ "Fn::FindInMap" : [ "VariableMap", "local", "APPxVERSION"] }, "ETH2", 
							{ "Ref" : "AWS::Region" } ] ] }
					},
					{
						"Key": "Owner",
						"Value": { "Ref" : "UserEmailTag" }
					},
					{
						"Key": "Options",
						"Value": { "Fn::FindInMap" : [ "VariableMap", "local", "OPTIONSxTAG"] }
					},
					{
						"Key": "Project",
						"Value": { "Fn::FindInMap" : [ "VariableMap", "local", "PROJECTxTAG"] }
					}
				]
			}
		},
		"BpsVirtualBlade1": {
			"Type": "AWS::EC2::Instance",
			"Properties": {
				"DisableApiTermination": { "Fn::FindInMap" : [ "VariableMap", "local", "INSTANCExDISABLExAPIxTERMINATION"] },
				"InstanceInitiatedShutdownBehavior": { "Fn::FindInMap" : [ "VariableMap", "local", "INSTANCExINSTANCExINITIATEDxSHUTDOWNxBEHAVIOR"] },
                "ImageId": "resolve:ssm:/aws/service/marketplace/prod-cl7jzjvfgu32i/26.0.0",
				"InstanceType": { "Ref" : "BPSvBladeInstanceType" },
				"KeyName": {"Ref": "SSHKey"},
				"Monitoring": { "Fn::FindInMap" : [ "VariableMap", "local", "INSTANCExMONITORING"] },
				"PlacementGroupName" : { "Ref" : "PlacementGroup" },
				"Tags": [
					{
						"Key": "Name",
						"Value": { "Fn::Join" : [ "_", [ { "Ref" : "UserLoginTag" }, { "Fn::FindInMap" : [ "VariableMap", "local", "PROJECTxTAG"] }, 
							{ "Fn::FindInMap" : [ "VariableMap", "local", "APPxTAG"] }, "VIRTUAL_BLADE1", 
							{ "Fn::FindInMap" : [ "VariableMap", "local", "APPxVERSION"] }, 
							{ "Fn::FindInMap" : [ "RegionMap", { "Ref" : "AWS::Region" }, "REGIONxTAG"]} ] ] }
					},
					{
						"Key": "Owner",
						"Value": { "Ref" : "UserEmailTag" }
					},
					{
						"Key": "Options",
						"Value": { "Fn::FindInMap" : [ "VariableMap", "local", "OPTIONSxTAG"] }
					},
					{
						"Key": "Project",
						"Value": { "Fn::FindInMap" : [ "VariableMap", "local", "PROJECTxTAG"] }
					}
				],
				"NetworkInterfaces": [
					{
						"NetworkInterfaceId": {
							"Ref": "BpsVirtualBlade1Eth0"
						},
						"DeviceIndex": "0"
					},
					{
						"NetworkInterfaceId": {
							"Ref": "BpsVirtualBlade1Eth1"
						},
						"DeviceIndex": "1"
					},
					{
						"NetworkInterfaceId": {
							"Ref": "BpsVirtualBlade1Eth2"
						},
						"DeviceIndex": "2"
					}
				],
				"BlockDeviceMappings" : [
					{
						"DeviceName" : { "Fn::FindInMap" : [ "VariableMap", "local", "INSTANCExBLOCKxDEVICExNAME"] },
						"Ebs" : { 
							"VolumeSize": { "Fn::FindInMap" : [ "VariableMap", "local", "VBLADExIMGxSIZE"] },
							"DeleteOnTermination" : { "Fn::FindInMap" : [ "VariableMap", "local", "INSTANCExEBSxDELETExONxTERMINATION"] },
							"VolumeType" : { "Fn::FindInMap" : [ "VariableMap", "local", "INSTANCExEBSxVOLUMExTYPE"] }
						}
					}
				]
			}
		},
		"BpsSystemController": {
			"Type": "AWS::EC2::Instance",
			"Properties": {
				"DisableApiTermination": { "Fn::FindInMap" : [ "VariableMap", "local", "INSTANCExDISABLExAPIxTERMINATION"] },
				"InstanceInitiatedShutdownBehavior": { "Fn::FindInMap" : [ "VariableMap", "local", "INSTANCExINSTANCExINITIATEDxSHUTDOWNxBEHAVIOR"] },
                "ImageId": "resolve:ssm:/aws/service/marketplace/prod-etszhwtguwj7m/26.0.0",
				"InstanceType": { "Ref" : "BPSSCInstanceType" },
				"KeyName": {"Ref": "SSHKey"},
				"Monitoring": { "Fn::FindInMap" : [ "VariableMap", "local", "INSTANCExMONITORING"] },
				"Tags": [
					{
						"Key": "Name",
						"Value": { "Fn::Join" : [ "_", [ { "Ref" : "UserLoginTag" }, { "Fn::FindInMap" : [ "VariableMap", "local", "PROJECTxTAG"] }, 
							{ "Fn::FindInMap" : [ "VariableMap", "local", "APPxTAG"] }, "SYSTEM_CONTROLLER", 
							{ "Fn::FindInMap" : [ "VariableMap", "local", "APPxVERSION"] }, 
							{ "Fn::FindInMap" : [ "RegionMap", { "Ref" : "AWS::Region" }, "REGIONxTAG"]} ] ] }
					},
					{
						"Key": "Owner",
						"Value": { "Ref" : "UserEmailTag" }
					},
					{
						"Key": "Options",
						"Value": { "Fn::FindInMap" : [ "VariableMap", "local", "OPTIONSxTAG"] }
					},
					{
						"Key": "Project",
						"Value": { "Fn::FindInMap" : [ "VariableMap", "local", "PROJECTxTAG"] }
					}
				],
				"NetworkInterfaces": [
					{
						"NetworkInterfaceId": {
							"Ref": "BpsSystemControllerCtrl0"
						},
						"DeviceIndex": "0"
					}
				],
				"BlockDeviceMappings" : [
					{
						"DeviceName" : { "Fn::FindInMap" : [ "VariableMap", "local", "INSTANCExBLOCKxDEVICExNAME"] },
						"Ebs" : { 
							"VolumeSize" : { "Fn::FindInMap" : [ "VariableMap", "local", "SYSCTRLxIMGxSIZE"] },
							"DeleteOnTermination" : { "Fn::FindInMap" : [ "VariableMap", "local", "INSTANCExEBSxDELETExONxTERMINATION"] },
							"VolumeType" : { "Fn::FindInMap" : [ "VariableMap", "local", "INSTANCExEBSxVOLUMExTYPE"] }
						}
					}
				]
			},
			"DependsOn": [
				"BpsVirtualBlade1"
			]
		},
		"CtrlElasticIp": {
			"Type": "AWS::EC2::EIP",
			"DependsOn": [
				"BpsSystemController"
			],
			"Properties": {
				"Domain": "vpc"
			}
		},
		"CtrlElasticIpAssociation": {
			"Type": "AWS::EC2::EIPAssociation",
			"Properties": {
				"AllocationId": {
					"Fn::GetAtt": [
						"CtrlElasticIp",
						"AllocationId"
					]
				},
				"NetworkInterfaceId": {
					"Ref": "BpsSystemControllerCtrl0"
				}
			}
		}
	},
	"Metadata" : {
		"AWS::CloudFormation::Interface" : {	
            "ParameterGroups": [
                {
                    "Label": {
                        "default": "User Tag Configuration"
                    },
                    "Parameters": [
                        "UserEmailTag",
						"UserLoginTag"
                    ]
                },
                {
                    "Label": {
                        "default": "Keysight BPS-VE Instance Configuration"
                    },
                    "Parameters": [
                        "SSHKey"
                    ]
                },
                {
                    "Label": {
                        "default": "Virtual Private Cloud Configuration"
                    },
                    "Parameters": [
                        "VpcId",
						"CtrlSubnetId",
						"Test1SubnetId",
						"Test2SubnetId"
                    ]
                },
                {
                    "Label": {
                        "default": "BreakingPoint Virtual Controller Instance Configuration"
                    },
                    "Parameters": [
                        "BPSSCInstanceType",
						"BPSSCCtrl0PrivateIpAddress"
                    ]
                },
                {
                    "Label": {
                        "default": "BreakingPoint Virtual Blade Instance Configuration"
                    },
                    "Parameters": [
                        "BPSvBladeInstanceType",
						"BPSvBlade1Eth0PrivateIpAddress",
						"BPSvBlade1Eth1PrivateIpAddresses",
						"BPSvBlade1Eth2PrivateIpAddresses"
                    ]
                },
                {
                    "Label": {
                        "default": "Security Group Configuration"
                    },
                    "Parameters": [
                        "InboundIPv4CidrBlock"
                    ]
                }				
			],
			"ParameterLabels": {
				"UserEmailTag": {
					"default": "User Email Tag"
				},
				"UserLoginTag": {
					"default": "User Login Tag"
				},
				"VpcId": {
					"default": "VPC ID"
				},
				"CtrlSubnetId": {
					"default": "Control Subnet ID"
				},
				"Test1SubnetId": {
					"default": "Test1 Subnet ID"
				},
				"Test2SubnetId": {
					"default": "Test2 Subnet ID"
				},
				"BPSSCInstanceType": {
					"default": "Virtual Controller Instance Type"
				},
				"BPSSCCtrl0PrivateIpAddress": {
					"default": "Virtual Controller Management Private IP Address"
				},
				"BPSvBladeInstanceType": {
					"default": "Virtual Blade Instance Type"
				},
				"BPSvBlade1Eth0PrivateIpAddress": {
					"default": "Virtual Blade #1 Eth0 Private IP Address"
				},
				"BPSvBlade1Eth1PrivateIpAddresses": {
					"default": "Virtual Blade #1 Eth1 Private IP Address CSV List"
				},
				"BPSvBlade1Eth2PrivateIpAddresses": {
					"default": "Virtual Blade #1 Eth2 Private IP Address CSV List"
				},
                "SSHKey": {
                    "default": "Keysight BPS-VE SSH Key"
                },
				"InboundIPv4CidrBlock": {
					"default": "Inbound IPv4 CIDR Block"
				}
			}
        }
    },
	"Outputs": {
		"BpsVirtualBlade1": {
			"Description": "KEY_BPS_VIRTUAL_BLADE1_PRIVATE_IP",
			"Value": {
				"Fn::GetAtt": [
					"BpsVirtualBlade1",
					"PrivateIp"
				]
			}
		},
		"BpsSystemController": {
			"Description": "KEY_BPS_SYSTEM_CONTROLLER_PUBLIC_DNS_NAME",
			"Value": {
				"Fn::Join": [
					"",
					[
						"https://",
						{
							"Fn::GetAtt": [
								"BpsSystemController",
								"PublicDnsName"
							]
						}
					]
				]
			}
		}
	}
}
